<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>坐标转换测试</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .input-group label {
            min-width: 80px;
            font-weight: 500;
        }

        .input-group input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .map-container {
            width: 100%;
            height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin-top: 15px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .result-table th,
        .result-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .result-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .result-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .coordinate-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .coordinate-info h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .accuracy-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .accuracy-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .back-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #218838;
        }

        .marker-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📍 坐标转换测试</h1>
            <p>测试GPS坐标与国内地图坐标的转换准确性</p>
        </div>

        <div class="test-section">
            <h3>🎯 当前位置测试</h3>
            <p>获取您的当前位置，测试坐标转换是否准确</p>
            <button class="btn" onclick="getCurrentLocation()" id="locationBtn">获取当前位置</button>
            
            <div id="locationResult" style="display: none;">
                <div class="coordinate-info">
                    <h4>📍 原始GPS坐标 (WGS-84)</h4>
                    <p>纬度: <span id="gpsLat"></span></p>
                    <p>经度: <span id="gpsLng"></span></p>
                    <p>精度: <span id="gpsAccuracy"></span> 米</p>
                </div>
                
                <div class="accuracy-info">
                    <h4>⚠️ 坐标偏移说明</h4>
                    <p>在中国境内，GPS坐标(WGS-84)与国内地图坐标(GCJ-02/BD-09)存在偏移：</p>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li><strong>高德地图/腾讯地图</strong>: 使用GCJ-02坐标系，偏移约50-500米</li>
                        <li><strong>百度地图</strong>: 使用BD-09坐标系，偏移更大</li>
                        <li><strong>OpenStreetMap</strong>: 使用WGS-84坐标系，无偏移</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🗺️ 地图显示测试</h3>
            <div class="input-group">
                <label>纬度:</label>
                <input type="number" id="testLat" placeholder="39.9042" step="0.000001">
                <label>经度:</label>
                <input type="number" id="testLng" placeholder="116.4074" step="0.000001">
                <button class="btn" onclick="testCoordinates()">测试坐标</button>
            </div>
            
            <div class="map-container" id="testMap"></div>
            <div class="marker-info" id="markerInfo">
                绿色: GPS坐标<br>
                红色: 转换后坐标
            </div>
        </div>

        <div class="test-section">
            <h3>📊 坐标转换对比</h3>
            <table class="result-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>地图源</th>
                        <th>坐标系</th>
                        <th>纬度</th>
                        <th>经度</th>
                        <th>偏移距离</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #666;">请输入坐标进行测试</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="back-btn" onclick="window.location.href='/'">返回主页</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/coordinate-converter.js"></script>
    <script src="/china-maps.js"></script>
    <script>
        let testMap = null;
        let gpsMarker = null;
        let convertedMarkers = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTestMap();
        });

        // 初始化测试地图
        function initTestMap() {
            try {
                const mapResult = createMapWithFallback('testMap', {
                    center: [39.9042, 116.4074],
                    zoom: 12,
                    fallbackSources: ['amap', 'baidu', 'tencent', 'osm']
                });
                
                testMap = mapResult.map;
                console.log(`测试地图使用: ${mapResult.sourceName} (${mapResult.coordinateSystem})`);
                
            } catch (error) {
                console.error('地图初始化失败:', error);
                testMap = L.map('testMap').setView([39.9042, 116.4074], 12);
            }
        }

        // 获取当前位置
        function getCurrentLocation() {
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            btn.textContent = '获取中...';

            if (!navigator.geolocation) {
                alert('您的浏览器不支持地理位置功能');
                btn.disabled = false;
                btn.textContent = '获取当前位置';
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    // 显示原始GPS坐标
                    document.getElementById('gpsLat').textContent = latitude.toFixed(6);
                    document.getElementById('gpsLng').textContent = longitude.toFixed(6);
                    document.getElementById('gpsAccuracy').textContent = accuracy ? accuracy.toFixed(0) : '未知';
                    
                    // 显示结果
                    document.getElementById('locationResult').style.display = 'block';
                    
                    // 在地图上显示
                    showLocationOnMap(latitude, longitude);
                    
                    // 更新测试输入框
                    document.getElementById('testLat').value = latitude.toFixed(6);
                    document.getElementById('testLng').value = longitude.toFixed(6);
                    
                    btn.disabled = false;
                    btn.textContent = '获取当前位置';
                },
                (error) => {
                    let message = '定位失败';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = '用户拒绝了位置权限请求';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = '位置信息不可用';
                            break;
                        case error.TIMEOUT:
                            message = '定位请求超时';
                            break;
                    }
                    alert(message);
                    
                    btn.disabled = false;
                    btn.textContent = '获取当前位置';
                },
                options
            );
        }

        // 测试坐标
        function testCoordinates() {
            const lat = parseFloat(document.getElementById('testLat').value);
            const lng = parseFloat(document.getElementById('testLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('请输入有效的坐标');
                return;
            }
            
            showLocationOnMap(lat, lng);
            updateComparisonTable(lat, lng);
        }

        // 在地图上显示位置
        function showLocationOnMap(lat, lng) {
            // 清除之前的标记
            if (gpsMarker) {
                testMap.removeLayer(gpsMarker);
            }
            Object.values(convertedMarkers).forEach(marker => {
                testMap.removeLayer(marker);
            });
            convertedMarkers = {};

            // 添加GPS坐标标记（绿色）
            gpsMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'gps-marker',
                    html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">GPS</div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(testMap);
            gpsMarker.bindPopup(`GPS坐标<br>纬度: ${lat.toFixed(6)}<br>经度: ${lng.toFixed(6)}`);

            // 添加转换后的坐标标记
            const mapSources = ['amap', 'baidu', 'tencent', 'osm'];
            const colors = ['#dc3545', '#ffc107', '#17a2b8', '#6f42c1'];
            
            mapSources.forEach((source, index) => {
                if (source !== 'osm') {
                    const converted = convertCoordinatesForMapSource(lng, lat, source);
                    const convertedLat = converted[1];
                    const convertedLng = converted[0];
                    
                    const marker = L.marker([convertedLat, convertedLng], {
                        icon: L.divIcon({
                            className: 'converted-marker',
                            html: `<div style="background: ${colors[index]}; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${source.toUpperCase().substring(0,2)}</div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(testMap);
                    
                    const distance = calculateDistance(lng, lat, convertedLng, convertedLat);
                    marker.bindPopup(`${source.toUpperCase()}坐标<br>纬度: ${convertedLat.toFixed(6)}<br>经度: ${convertedLng.toFixed(6)}<br>偏移: ${distance.toFixed(0)}米`);
                    
                    convertedMarkers[source] = marker;
                }
            });

            // 调整地图视图
            testMap.setView([lat, lng], 15);
        }

        // 更新对比表格
        function updateComparisonTable(lat, lng) {
            const tbody = document.getElementById('comparisonBody');
            tbody.innerHTML = '';

            const mapSources = [
                { key: 'osm', name: 'OpenStreetMap', coord: 'WGS-84' },
                { key: 'amap', name: '高德地图', coord: 'GCJ-02' },
                { key: 'baidu', name: '百度地图', coord: 'BD-09' },
                { key: 'tencent', name: '腾讯地图', coord: 'GCJ-02' }
            ];

            mapSources.forEach(source => {
                const row = document.createElement('tr');
                
                let convertedLat = lat;
                let convertedLng = lng;
                let distance = 0;
                
                if (source.key !== 'osm') {
                    const converted = convertCoordinatesForMapSource(lng, lat, source.key);
                    convertedLng = converted[0];
                    convertedLat = converted[1];
                    distance = calculateDistance(lng, lat, convertedLng, convertedLat);
                }
                
                row.innerHTML = `
                    <td>${source.name}</td>
                    <td>${source.coord}</td>
                    <td>${convertedLat.toFixed(6)}</td>
                    <td>${convertedLng.toFixed(6)}</td>
                    <td>${distance.toFixed(0)} 米</td>
                `;
                
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
