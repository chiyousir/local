<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åæ ‡è½¬æ¢æµ‹è¯•</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .input-group label {
            min-width: 80px;
            font-weight: 500;
        }

        .input-group input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .map-container {
            width: 100%;
            height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin-top: 15px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .result-table th,
        .result-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .result-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .result-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .coordinate-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .coordinate-info h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .accuracy-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .accuracy-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .back-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #218838;
        }

        .marker-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ åæ ‡è½¬æ¢æµ‹è¯•</h1>
            <p>æµ‹è¯•GPSåæ ‡ä¸å›½å†…åœ°å›¾åæ ‡çš„è½¬æ¢å‡†ç¡®æ€§</p>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ å½“å‰ä½ç½®æµ‹è¯•</h3>
            <p>è·å–æ‚¨çš„å½“å‰ä½ç½®ï¼Œæµ‹è¯•åæ ‡è½¬æ¢æ˜¯å¦å‡†ç¡®</p>
            <button class="btn" onclick="getCurrentLocation()" id="locationBtn">è·å–å½“å‰ä½ç½®</button>
            
            <div id="locationResult" style="display: none;">
                <div class="coordinate-info">
                    <h4>ğŸ“ åŸå§‹GPSåæ ‡ (WGS-84)</h4>
                    <p>çº¬åº¦: <span id="gpsLat"></span></p>
                    <p>ç»åº¦: <span id="gpsLng"></span></p>
                    <p>ç²¾åº¦: <span id="gpsAccuracy"></span> ç±³</p>
                </div>
                
                <div class="accuracy-info">
                    <h4>âš ï¸ åæ ‡åç§»è¯´æ˜</h4>
                    <p>åœ¨ä¸­å›½å¢ƒå†…ï¼ŒGPSåæ ‡(WGS-84)ä¸å›½å†…åœ°å›¾åæ ‡(GCJ-02/BD-09)å­˜åœ¨åç§»ï¼š</p>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li><strong>é«˜å¾·åœ°å›¾/è…¾è®¯åœ°å›¾</strong>: ä½¿ç”¨GCJ-02åæ ‡ç³»ï¼Œåç§»çº¦50-500ç±³</li>
                        <li><strong>ç™¾åº¦åœ°å›¾</strong>: ä½¿ç”¨BD-09åæ ‡ç³»ï¼Œåç§»æ›´å¤§</li>
                        <li><strong>OpenStreetMap</strong>: ä½¿ç”¨WGS-84åæ ‡ç³»ï¼Œæ— åç§»</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ—ºï¸ åœ°å›¾æ˜¾ç¤ºæµ‹è¯•</h3>
            <div class="input-group">
                <label>çº¬åº¦:</label>
                <input type="number" id="testLat" placeholder="39.9042" step="0.000001">
                <label>ç»åº¦:</label>
                <input type="number" id="testLng" placeholder="116.4074" step="0.000001">
                <button class="btn" onclick="testCoordinates()">æµ‹è¯•åæ ‡</button>
            </div>
            
            <div class="map-container" id="testMap"></div>
            <div class="marker-info" id="markerInfo">
                ç»¿è‰²: GPSåæ ‡<br>
                çº¢è‰²: è½¬æ¢ååæ ‡
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š åæ ‡è½¬æ¢å¯¹æ¯”</h3>
            <table class="result-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>åœ°å›¾æº</th>
                        <th>åæ ‡ç³»</th>
                        <th>çº¬åº¦</th>
                        <th>ç»åº¦</th>
                        <th>åç§»è·ç¦»</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #666;">è¯·è¾“å…¥åæ ‡è¿›è¡Œæµ‹è¯•</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="back-btn" onclick="window.location.href='/'">è¿”å›ä¸»é¡µ</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/coordinate-converter.js"></script>
    <script src="/china-maps.js"></script>
    <script>
        let testMap = null;
        let gpsMarker = null;
        let convertedMarkers = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTestMap();
        });

        // åˆå§‹åŒ–æµ‹è¯•åœ°å›¾
        function initTestMap() {
            try {
                const mapResult = createMapWithFallback('testMap', {
                    center: [39.9042, 116.4074],
                    zoom: 12,
                    fallbackSources: ['amap', 'baidu', 'tencent', 'osm']
                });
                
                testMap = mapResult.map;
                console.log(`æµ‹è¯•åœ°å›¾ä½¿ç”¨: ${mapResult.sourceName} (${mapResult.coordinateSystem})`);
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                testMap = L.map('testMap').setView([39.9042, 116.4074], 12);
            }
        }

        // è·å–å½“å‰ä½ç½®
        function getCurrentLocation() {
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            btn.textContent = 'è·å–ä¸­...';

            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½');
                btn.disabled = false;
                btn.textContent = 'è·å–å½“å‰ä½ç½®';
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    // æ˜¾ç¤ºåŸå§‹GPSåæ ‡
                    document.getElementById('gpsLat').textContent = latitude.toFixed(6);
                    document.getElementById('gpsLng').textContent = longitude.toFixed(6);
                    document.getElementById('gpsAccuracy').textContent = accuracy ? accuracy.toFixed(0) : 'æœªçŸ¥';
                    
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('locationResult').style.display = 'block';
                    
                    // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º
                    showLocationOnMap(latitude, longitude);
                    
                    // æ›´æ–°æµ‹è¯•è¾“å…¥æ¡†
                    document.getElementById('testLat').value = latitude.toFixed(6);
                    document.getElementById('testLng').value = longitude.toFixed(6);
                    
                    btn.disabled = false;
                    btn.textContent = 'è·å–å½“å‰ä½ç½®';
                },
                (error) => {
                    let message = 'å®šä½å¤±è´¥';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®æƒé™è¯·æ±‚';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                            break;
                        case error.TIMEOUT:
                            message = 'å®šä½è¯·æ±‚è¶…æ—¶';
                            break;
                    }
                    alert(message);
                    
                    btn.disabled = false;
                    btn.textContent = 'è·å–å½“å‰ä½ç½®';
                },
                options
            );
        }

        // æµ‹è¯•åæ ‡
        function testCoordinates() {
            const lat = parseFloat(document.getElementById('testLat').value);
            const lng = parseFloat(document.getElementById('testLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åæ ‡');
                return;
            }
            
            showLocationOnMap(lat, lng);
            updateComparisonTable(lat, lng);
        }

        // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºä½ç½®
        function showLocationOnMap(lat, lng) {
            // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
            if (gpsMarker) {
                testMap.removeLayer(gpsMarker);
            }
            Object.values(convertedMarkers).forEach(marker => {
                testMap.removeLayer(marker);
            });
            convertedMarkers = {};

            // æ·»åŠ GPSåæ ‡æ ‡è®°ï¼ˆç»¿è‰²ï¼‰
            gpsMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'gps-marker',
                    html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">GPS</div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(testMap);
            gpsMarker.bindPopup(`GPSåæ ‡<br>çº¬åº¦: ${lat.toFixed(6)}<br>ç»åº¦: ${lng.toFixed(6)}`);

            // æ·»åŠ è½¬æ¢åçš„åæ ‡æ ‡è®°
            const mapSources = ['amap', 'baidu', 'tencent', 'osm'];
            const colors = ['#dc3545', '#ffc107', '#17a2b8', '#6f42c1'];
            
            mapSources.forEach((source, index) => {
                if (source !== 'osm') {
                    const converted = convertCoordinatesForMapSource(lng, lat, source);
                    const convertedLat = converted[1];
                    const convertedLng = converted[0];
                    
                    const marker = L.marker([convertedLat, convertedLng], {
                        icon: L.divIcon({
                            className: 'converted-marker',
                            html: `<div style="background: ${colors[index]}; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${source.toUpperCase().substring(0,2)}</div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(testMap);
                    
                    const distance = calculateDistance(lng, lat, convertedLng, convertedLat);
                    marker.bindPopup(`${source.toUpperCase()}åæ ‡<br>çº¬åº¦: ${convertedLat.toFixed(6)}<br>ç»åº¦: ${convertedLng.toFixed(6)}<br>åç§»: ${distance.toFixed(0)}ç±³`);
                    
                    convertedMarkers[source] = marker;
                }
            });

            // è°ƒæ•´åœ°å›¾è§†å›¾
            testMap.setView([lat, lng], 15);
        }

        // æ›´æ–°å¯¹æ¯”è¡¨æ ¼
        function updateComparisonTable(lat, lng) {
            const tbody = document.getElementById('comparisonBody');
            tbody.innerHTML = '';

            const mapSources = [
                { key: 'osm', name: 'OpenStreetMap', coord: 'WGS-84' },
                { key: 'amap', name: 'é«˜å¾·åœ°å›¾', coord: 'GCJ-02' },
                { key: 'baidu', name: 'ç™¾åº¦åœ°å›¾', coord: 'BD-09' },
                { key: 'tencent', name: 'è…¾è®¯åœ°å›¾', coord: 'GCJ-02' }
            ];

            mapSources.forEach(source => {
                const row = document.createElement('tr');
                
                let convertedLat = lat;
                let convertedLng = lng;
                let distance = 0;
                
                if (source.key !== 'osm') {
                    const converted = convertCoordinatesForMapSource(lng, lat, source.key);
                    convertedLng = converted[0];
                    convertedLat = converted[1];
                    distance = calculateDistance(lng, lat, convertedLng, convertedLat);
                }
                
                row.innerHTML = `
                    <td>${source.name}</td>
                    <td>${source.coord}</td>
                    <td>${convertedLat.toFixed(6)}</td>
                    <td>${convertedLng.toFixed(6)}</td>
                    <td>${distance.toFixed(0)} ç±³</td>
                `;
                
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
